<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Race Game – IA Infinita (Stream Final)</title>

<style>
body{
  margin:0;
  background:#0b1020;
  font-family:system-ui, Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  color:#e8eeff;
}
.wrap{width:520px}
canvas{
  width:100%;
  background:#111a33;
  border-radius:14px;
  display:block;
}
.hud{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
  font-weight:600;
}
.note{
  text-align:center;
  font-size:12px;
  opacity:0.7;
  margin-top:4px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="hud">
    <div>Pontos: <span id="score">0</span></div>
    <div>Faixa IA: <span id="lane">1</span></div>
  </div>
  <canvas id="game" width="480" height="800"></canvas>
  <div class="note">Modo infinito real • IA contínua • Sem resets</div>
</div>

<script>
/* ================= CONFIG ================= */
const LANES = 3;

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;

/* ================= HUD ================= */
const elScore = document.getElementById("score");
const elLane = document.getElementById("lane");

/* ================= ROAD ================= */
const road = {
  x: W / 2,
  width: W * 0.66
};

/* ================= PLAYER ================= */
const player = {
  lane: 1,
  x: 0,
  y: H * 0.8,
  w: 52,
  h: 96
};

/* ================= STATE ================= */
let score = 0;
let speed = 360;
let speedGrowth = 3;        // crescimento contínuo
let spawnTimer = 0;
let spawnEvery = 1.1;       // nunca “trava” padrões

/* ================= OBJECTS ================= */
const enemies = [];

/* ================= LANES ================= */
function laneCenter(lane){
  const left = road.x - road.width / 2;
  const laneW = road.width / LANES;
  return left + laneW * (lane + 0.5);
}

/* ================= SPAWN ================= */
function spawnEnemy(){
  const lane = Math.floor(Math.random() * LANES);
  enemies.push({
    lane,
    x: laneCenter(lane),
    y: -140,
    w: 52,
    h: 96,
    vy: speed * (0.85 + Math.random()*0.2)
  });
}

/* ================= IA (SUAVE E INFINITA) ================= */
function chooseBestLane(){
  const danger = new Array(LANES).fill(0);

  for(const e of enemies){
    const dy = player.y - e.y;
    if(dy > 0 && dy < 300){
      danger[e.lane] += 1 / dy;
    }
  }

  let best = player.lane;
  let min = danger[player.lane];

  for(let i=0;i<LANES;i++){
    if(danger[i] < min){
      min = danger[i];
      best = i;
    }
  }
  return best;
}

/* ================= LOOP ================= */
let last = performance.now();
requestAnimationFrame(loop);

function loop(now){
  const dt = Math.min(0.033, (now - last) / 1000);
  last = now;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}

/* ================= UPDATE ================= */
function update(dt){
  /* score infinito */
  score += dt * 120;
  elScore.textContent = Math.floor(score);

  /* aceleração contínua (sem ciclos) */
  speed += speedGrowth * dt;

  /* IA decide */
  const targetLane = chooseBestLane();
  elLane.textContent = targetLane;

  /* movimento SUAVE */
  const targetX = laneCenter(targetLane);
  player.x += (targetX - player.x) * 6 * dt;
  player.lane = targetLane;

  /* spawn */
  spawnTimer += dt;
  if(spawnTimer > spawnEvery){
    spawnTimer = 0;
    spawnEnemy();
  }

  /* move inimigos */
  for(let i=enemies.length-1;i>=0;i--){
    enemies[i].y += enemies[i].vy * dt;

    /* nunca remover abruptamente perto do player */
    if(enemies[i].y > H + 300){
      enemies.splice(i,1);
    }
  }
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle="#1b2a62";
  ctx.fillRect(0,0,W,H);

  ctx.fillStyle="#0b0f1c";
  ctx.fillRect(road.x-road.width/2,0,road.width,H);

  ctx.strokeStyle="rgba(255,255,255,0.25)";
  ctx.setLineDash([24,18]);
  ctx.lineWidth=4;
  for(let i=1;i<LANES;i++){
    const x = laneCenter(i) - road.width / LANES / 2;
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,H);
    ctx.stroke();
  }
  ctx.setLineDash([]);

  /* inimigos */
  ctx.fillStyle="#ff5a7a";
  for(const e of enemies){
    ctx.fillRect(e.x-e.w/2,e.y-e.h/2,e.w,e.h);
  }

  /* player */
  ctx.fillStyle="#4de3a5";
  ctx.fillRect(
    player.x-player.w/2,
    player.y-player.h/2,
    player.w,
    player.h
  );
}
</script>
</body>
</html>
