<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Race Game – IA Stream Mode</title>

<style>
body{
  margin:0;
  background:#0b1020;
  font-family:system-ui, Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  color:#e8eeff;
}
.wrap{width:520px}
canvas{
  width:100%;
  background:#111a33;
  border-radius:14px;
  display:block;
}
.hud{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
  font-weight:600;
}
.note{
  text-align:center;
  font-size:12px;
  opacity:0.7;
  margin-top:4px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="hud">
    <div>Pontos: <span id="score">0</span></div>
    <div>Faixa IA: <span id="lane">1</span></div>
  </div>
  <canvas id="game" width="480" height="800"></canvas>
  <div class="note">Modo IA ativa • Sem controle humano</div>
</div>

<script>
/* ========= CONFIG ========= */
const LANES = 3;

/* ========= CANVAS ========= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;

/* ========= HUD ========= */
const elScore = document.getElementById("score");
const elLane = document.getElementById("lane");

/* ========= ROAD ========= */
const road = {
  x: W / 2,
  width: W * 0.66
};

/* ========= PLAYER ========= */
const player = {
  lane: 1,
  x: 0,
  y: H * 0.8,
  w: 44,
  h: 78
};

/* ========= STATE ========= */
let score = 0;
let speed = 420;
let spawnTimer = 0;
let spawnEvery = 0.9;

/* ========= OBJECTS ========= */
const enemies = [];

/* ========= LANES ========= */
function laneCenter(lane){
  const left = road.x - road.width / 2;
  const laneW = road.width / LANES;
  return left + laneW * (lane + 0.5);
}

/* ========= SPAWN ========= */
function spawnEnemy(){
  const lane = Math.floor(Math.random() * LANES);
  enemies.push({
    lane,
    x: laneCenter(lane),
    y: -120,
    w: 44,
    h: 78
  });
}

/* ========= IA (STREAM SAFE) ========= */
/*
  Regra simples e confiável:
  - Conta quantos inimigos existem em cada faixa À FRENTE
  - Escolhe sempre a faixa menos ocupada
  - Sem aceleração, sem hesitação
*/
function chooseBestLane(){
  const danger = new Array(LANES).fill(0);

  for(const e of enemies){
    if(e.y < player.y){
      danger[e.lane]++;
    }
  }

  let best = 0;
  for(let i = 1; i < LANES; i++){
    if(danger[i] < danger[best]){
      best = i;
    }
  }
  return best;
}

/* ========= LOOP ========= */
let last = performance.now();
requestAnimationFrame(loop);

function loop(now){
  const dt = Math.min(0.033, (now - last) / 1000);
  last = now;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}

/* ========= UPDATE ========= */
function update(dt){
  score += dt * 100;
  elScore.textContent = score | 0;

  /* --- IA decide faixa --- */
  player.lane = chooseBestLane();
  elLane.textContent = player.lane;

  /* --- posição FORÇADA (stream-safe) --- */
  player.x = laneCenter(player.lane);

  /* --- spawn inimigos --- */
  spawnTimer += dt;
  if(spawnTimer > spawnEvery){
    spawnTimer = 0;
    spawnEnemy();
  }

  /* --- move inimigos --- */
  for(let i = enemies.length - 1; i >= 0; i--){
    enemies[i].y += speed * dt;

    /* colisão (reset limpo para live) */
    if(
      enemies[i].lane === player.lane &&
      Math.abs(enemies[i].y - player.y) < player.h / 2
    ){
      enemies.length = 0;
      score = 0;
      break;
    }

    if(enemies[i].y > H + 120){
      enemies.splice(i,1);
    }
  }
}

/* ========= DRAW ========= */
function draw(){
  ctx.clearRect(0,0,W,H);

  /* fundo */
  ctx.fillStyle="#1b2a62";
  ctx.fillRect(0,0,W,H);

  /* pista */
  ctx.fillStyle="#0b0f1c";
  ctx.fillRect(
    road.x-road.width/2,
    0,
    road.width,
    H
  );

  /* linhas */
  ctx.strokeStyle="rgba(255,255,255,0.25)";
  ctx.setLineDash([24,18]);
  ctx.lineWidth=4;
  for(let i=1;i<LANES;i++){
    const x = laneCenter(i) - road.width / LANES / 2;
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,H);
    ctx.stroke();
  }
  ctx.setLineDash([]);

  /* inimigos */
  ctx.fillStyle="#ff5a7a";
  for(const e of enemies){
    ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h);
  }

  /* jogador */
  ctx.fillStyle="#4de3a5";
  ctx.fillRect(
    player.x-player.w/2,
    player.y-player.h/2,
    player.w,
    player.h
  );
}
</script>
</body>
</html>
