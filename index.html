<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Race Game – 3 Pistas (Stream Safe)</title>

<style>
body{
  margin:0;
  background:#0b1020;
  font-family:system-ui, Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  color:#e8eeff;
}
.wrap{width:520px}
canvas{
  width:100%;
  background:#111a33;
  border-radius:14px;
  display:block;
}
.hud{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
  font-weight:600;
}
.note{
  text-align:center;
  font-size:12px;
  opacity:0.7;
  margin-top:4px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="hud">
    <div>Pontos: <span id="score">0</span></div>
    <div>Pista IA: <span id="lane">1</span></div>
  </div>
  <canvas id="game" width="480" height="800"></canvas>
  <div class="note">3 pistas • spawn controlado • infinito real</div>
</div>

<script>
/* ================= CONFIG ================= */
const LANES = 3;
const SPEED = 360;             // dificuldade fixa
const SPAWN_INTERVAL = 1.1;    // ritmo fixo
const BLOCK_WINDOW = 240;      // altura mínima entre ondas

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;

/* ================= HUD ================= */
const elScore = document.getElementById("score");
const elLane  = document.getElementById("lane");

/* ================= ROAD ================= */
const road = {
  x: W / 2,
  width: W * 0.66
};

/* ================= PLAYER ================= */
const player = {
  lane: 1,
  x: 0,
  y: H * 0.8,
  w: 52,
  h: 96
};

/* ================= STATE ================= */
let score = 0;
let spawnTimer = 0;

/* ================= OBJECTS ================= */
const enemies = [];

/* ================= POSIÇÕES ================= */
function laneCenter(lane){
  const left = road.x - road.width / 2;
  const laneW = road.width / LANES;
  return left + laneW * (lane + 0.5);
}

/* ================= SPAWN VALIDADO ================= */
/*
  Cria uma "onda" de spawn:
  - escolhe 1 ou 2 pistas aleatórias
  - valida para nunca ocupar as 3
*/
function spawnWave(){
  const lanes = [0,1,2];

  // embaralha pistas
  for(let i=lanes.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [lanes[i], lanes[j]] = [lanes[j], lanes[i]];
  }

  const count = Math.random() < 0.7 ? 1 : 2; // maioria 1 pista
  const selected = lanes.slice(0, count);

  for(const lane of selected){
    enemies.push({
      lane,
      x: laneCenter(lane),
      y: -BLOCK_WINDOW,
      w: 52,
      h: 96
    });
  }
}

/* ================= IA ================= */
function chooseSafeLane(){
  const danger = new Array(LANES).fill(0);

  for(const e of enemies){
    const dy = player.y - e.y;
    if(dy > 0 && dy < BLOCK_WINDOW){
      danger[e.lane] += 1 / dy;
    }
  }

  let best = player.lane;
  let min = danger[player.lane];

  for(let i=0;i<LANES;i++){
    if(danger[i] < min){
      min = danger[i];
      best = i;
    }
  }
  return best;
}

/* ================= LOOP ================= */
let last = performance.now();
requestAnimationFrame(loop);

function loop(now){
  const dt = Math.min(0.033, (now - last) / 1000);
  last = now;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}

/* ================= UPDATE ================= */
function update(dt){
  score += dt * 100;
  elScore.textContent = Math.floor(score);

  /* IA */
  const targetLane = chooseSafeLane();
  elLane.textContent = targetLane;
  const targetX = laneCenter(targetLane);

  // movimento suave
  player.x += (targetX - player.x) * 6 * dt;
  player.lane = targetLane;

  /* spawn */
  spawnTimer += dt;
  if(spawnTimer >= SPAWN_INTERVAL){
    spawnTimer = 0;
    spawnWave();
  }

  /* move inimigos */
  for(let i=enemies.length-1;i>=0;i--){
    enemies[i].y += SPEED * dt;
    if(enemies[i].y > H + 400){
      enemies.splice(i,1);
    }
  }
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle="#1b2a62";
  ctx.fillRect(0,0,W,H);

  ctx.fillStyle="#0b0f1c";
  ctx.fillRect(road.x-road.width/2,0,road.width,H);

  ctx.strokeStyle="rgba(255,255,255,0.25)";
  ctx.setLineDash([24,18]);
  ctx.lineWidth=4;
  for(let i=1;i<LANES;i++){
    const x = laneCenter(i) - road.width / LANES / 2;
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,H);
    ctx.stroke();
  }
  ctx.setLineDash([]);

  /* inimigos */
  ctx.fillStyle="#ff5a7a";
  for(const e of enemies){
    ctx.fillRect(e.x-e.w/2,e.y-e.h/2,e.w,e.h);
  }

  /* jogador */
  ctx.fillStyle="#4de3a5";
  ctx.fillRect(
    player.x-player.w/2,
    player.y-player.h/2,
    player.w,
    player.h
  );
}
</script>
</body>
</html>
